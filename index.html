<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FCI-G Dashboard (Mobile-first)</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
    :root{
      --card-bg:#fff;--shadow:0 10px 25px rgba(0,0,0,0.08);
      --pad:14px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: #f7fafc;
      color:#111827;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      padding:12px;
    }
    #cardsContainer{
      width:100%;
      max-width:1000px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background:var(--card-bg);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      touch-action: manipulation; /* keep taps snappy */
    }
    .card.dragging{
      opacity:.95;
      z-index: 5;
    }
    .card-placeholder{
      border:2px dashed #cbd5e1;
      border-radius:16px;
      background: #f1f5f9;
      height:60px;
      margin:0;
    }
    .card-header{
      display:flex; align-items:center; gap:10px;
      padding: var(--pad);
      background:#f1f5f9;
      border-bottom:1px solid #e5e7eb;
      user-select:none;
    }
    .card-header h2{
      margin:0; font-size:16px; line-height:1.2; flex:1; font-weight:600;
    }
    .card-controls{display:flex; gap:8px; align-items:center;}
    .btn, .drag-handle{
      border:1px solid #d1d5db; background:#fff;
      border-radius:10px; padding:6px 10px; font-size:13px; cursor:pointer;
    }
    .btn:active, .drag-handle:active{transform: scale(0.98)}
    .drag-handle{font-weight:700; cursor:grab; touch-action:none;}
    .card-body{padding: var(--pad); background:#fff;}
    .card.collapsed .card-body{display:none}
    .card.collapsed .btn-collapse::after{content:"▸"}
    .btn-collapse::after{content:"▾"}

    /* Charts sizing: mobile-first */
    #chart1,#chart1b,#chart2,#chart3,#impactChart{width:100%; height:420px}
    #corrRolling3m,#simulationPlot,#plot_pred_curve{width:100%; height:360px}

    .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px}
    .controls input, .controls select, .controls button{
      padding:6px 9px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:14px
    }

    /* Larger screens */
    @media (min-width: 700px){
      :root{--pad:16px}
      #chart1,#chart1b,#chart2,#chart3,#impactChart{height:520px}
      #corrRolling3m,#simulationPlot,#plot_pred_curve{height:420px}
      .card-header h2{font-size:18px}
    }
  
/* Theme support */
:root{
  --bg:#f7fafc; --fg:#111827; --card-bg:#fff; --card-header-bg:#f1f5f9; --border:#e5e7eb; --badge-bg:#eef2ff; --badge-fg:#111827;
}
html.dark{
  --bg:#0b1220; --fg:#e8eef9; --card-bg:#121b2f; --card-header-bg:#182238; --border:#213054; --badge-bg:#192544; --badge-fg:#cde1ff;
}
body{ background:var(--bg); color:var(--fg); }
.card{ background:var(--card-bg); }
.card-header{ background:var(--card-header-bg); border-bottom:1px solid var(--border); }
.btn,.drag-handle{ border-color:var(--border); background:var(--card-bg); color:var(--fg); }
.card-body{ background:var(--card-bg); }
#fcigBadge{ background:var(--badge-bg)!important; color:var(--badge-fg)!important; border-color:var(--border)!important; }
</style>
</head>
<section class="card" data-id="card-about">
<div class="card-header">
<h2>Co mierzy FCI‑G?</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body" style="line-height:1.45">
<p style="margin:0 0 8px">
<strong>FCI‑G</strong> to indeks warunków finansowych opracowany przez pracowników Rady FED. Łączy on
      siedem zmiennych: stopę funduszy federalnych, rentowność 10‑letnich UST, 30‑letnią stopę hipoteczną,
      spread obligacji korporacyjnych BBB, szeroki indeks akcji, ceny domów oraz nominalny szeroki indeks USD.
      Wagi pochodzą z modeli (m.in. FRB/US) i odzwierciedlają łączny wpływ <em>trwałej</em> zmiany tych zmiennych
      na wzrost PKB w kolejnym roku — dzięki czemu indeks można interpretować jako „wiatr w plecy” (wartości ujemne)
      lub „przeciwny wiatr” (dodatnie) dla aktywności gospodarczej.
    </p>
<p style="margin:0;color:#6b7280">
      Źródło: FEDS Notes, „A New Index to Measure U.S. Financial Conditions”
      (<a href="https://www.federalreserve.gov/econres/notes/feds-notes/a-new-index-to-measure-us-financial-conditions-20230630.html" rel="noopener" target="_blank">link</a>).
    </p>
</div>
</section>
<section class="card" data-id="card-stacked">
<div class="card-header">
<h2>Financial Conditions (Stacked Bars + FCI-G)</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body"><div id="chart1"></div></div>
</section>
<section class="card" data-id="card-lines">
<div class="card-header">
<h2>Komponenty i FCI-G (linie)</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body"><div id="chart1b"></div></div>
</section>
<section class="card" data-id="card-shares">
<div class="card-header">
<h2>Procentowy udział komponentów w FCI-G</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body"><div id="chart2"></div></div>
</section>
<section class="card" data-id="card-history-shares">
<div class="card-header">
<h2>Historyczne udziały komponentów</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body"><div id="chart3"></div></div>
</section>
<section class="card" data-id="card-impact">
<div class="card-header">
<h2>Zmiany komponentów i indeksu w wybranym okresie</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body">
<div class="controls">
<label>Od: <input id="startDate" type="date"/></label>
<label>Do: <input id="endDate" type="date"/></label>
<button onclick="applyRange()">Zastosuj</button>
<button onclick="quickRange('ytd')">YTD</button>
<button onclick="quickRange(1)">1Y</button>
<button onclick="quickRange(3)">3Y</button>
<button onclick="quickRange(5)">5Y</button>
<button onclick="quickRange('all')">All</button>
</div>
<div id="impactChart"></div>
</div>
</section>
<section class="card" data-id="card-corr">
<div class="card-header">
<h2>FCI-G ↔ BTC — korelacja i 3M rolling (miesięcznie)</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body">
<div class="controls">
<label>Od: <input id="corrFrom" type="month"/></label>
<label>Do: <input id="corrTo" type="month"/></label>
<label style="display:flex;gap:6px;align-items:center;">
<input checked="" id="useChanges" type="checkbox"/> Użyj zmian (ΔFCI-G vs log-zwroty BTC)
          </label>
<button id="corrRun">Oblicz korelację</button>
<div><strong>Wynik:</strong> <span id="corrValue">—</span></div>
</div>
<div id="corrRolling3m"></div>
</div>
</section>
<section class="card" data-id="card-sim">
<div class="card-header">
<h2>Symulacja: BTC = S · e<sup>α + β·FCI_G</sup></h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body">
<div class="controls">
<label>Zakres FCI-G (min,max): <input id="simRange" type="text" value="-3,3"/></label>
<label>FCI-G: <input id="simSlider" max="3" min="-3" step="0.01" type="range" value="0"/></label>
<div><strong>BTC:</strong> <span id="simOut">—</span></div>
<div style="opacity:.8">Zakres danych: <code>[-0.78, 1.00]</code> — poza nim (zacienienie) to ekstrapolacja.</div>
</div>
<div id="simulationPlot"></div>
</div>
</section>
<section class="card" data-id="card-predcurve">
<div class="card-header">
<h2>BTC vs FCI-G: Simple Prediction Curve (No Bands)</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body">
<div class="controls">
<label>Skala Y:
            <select id="pred-y-scale">
<option value="linear">linear</option>
<option value="log">log</option>
</select>
</label>
<small style="opacity:.8">Model: BTC(f) = A·e^{k·f}, A=61090.941, k=−1.14035</small>
</div>
<div id="plot_pred_curve"></div>
</div>
</section>
<section class="card" data-id="card-sources">
<div class="card-header">
<h2>Źródła</h2>
<div class="card-controls">
<button class="btn btn-collapse" title="Zwiń/rozwiń"></button>
<div class="drag-handle" title="Przeciągnij (przytrzymaj)">⋮⋮</div>
</div>
</div>
<div class="card-body">
<ul style="margin:0 0 0 18px">
<li>Dane FCI‑G: <a href="https://github.com/dankostecki/FCIG/blob/main/data/converted.json" rel="noopener" target="_blank">converted.json</a></li>
<li>Opis metodyki (Fed): <a href="https://www.federalreserve.gov/econres/notes/feds-notes/a-new-index-to-measure-us-financial-conditions-20230630.html" rel="noopener" target="_blank">A New Index to Measure U.S. Financial Conditions</a></li>
</ul>
</div>
</section>
</div>
<script>
    /* =========================
       Dane wbudowane + model
       ========================= */
    const BTC_SERIES = [
      { month: "2022-09", price: 19415.8 },
      { month: "2022-10", price: 20472.79 },
      { month: "2022-11", price: 17179.78 },
      { month: "2022-12", price: 16531.0 },
      { month: "2023-01", price: 23134.74 },
      { month: "2023-02", price: 23146.93 },
      { month: "2023-03", price: 28492.72 },
      { month: "2023-04", price: 29271.16 },
      { month: "2023-05", price: 27222.9 },
      { month: "2023-06", price: 30475.82 },
      { month: "2023-07", price: 29223.31 },
      { month: "2023-08", price: 25922.51 },
      { month: "2023-09", price: 26959.4 },
      { month: "2023-10", price: 34667.88 },
      { month: "2023-11", price: 37743.0 },
      { month: "2023-12", price: 42300.78 },
      { month: "2024-01", price: 42599.49 },
      { month: "2024-02", price: 61240.13 },
      { month: "2024-03", price: 71213.11 },
      { month: "2024-04", price: 60690.8 },
      { month: "2024-05", price: 67506.03 },
      { month: "2024-06", price: 62678.1 },
      { month: "2024-07", price: 64607.71 },
      { month: "2024-08", price: 58956.52 },
      { month: "2024-09", price: 60790.0 },
      { month: "2024-10", price: 69467.29 },
      { month: "2024-11", price: 97263.18 },
      { month: "2024-12", price: 94383.59 },
      { month: "2025-01", price: 100623.85 },
      { month: "2025-02", price: 86018.76 },
      { month: "2025-03", price: 85170.37 },
      { month: "2025-04", price: 96524.98 },
      { month: "2025-05", price: 105697.94 },
      { month: "2025-06", price: 105711.78 },
      { month: "2025-07", price: 113248.73 },
    ];
    const MODEL = { A: 61090.941, k: -1.14035, dataRange: [-0.78, 1.00] };
    const predFn = (f) => MODEL.A * Math.exp(MODEL.k * f);

    /* Helpers */
    const toMonthKey = (iso) => iso.split("-").slice(0,2).join("-");
    function correlation(x,y){const n=x.length,mx=x.reduce((s,v)=>s+v,0)/n,my=y.reduce((s,v)=>s+v,0)/n;let num=0,dx=0,dy=0;for(let i=0;i<n;i++){const xa=x[i]-mx,yb=y[i]-my;num+=xa*yb;dx+=xa*xa;dy+=yb*yb;}return num/Math.sqrt(dx*dy);}
    function rollingCorrelation(a,b,w){const out=new Array(a.length).fill(null);for(let i=w-1;i<a.length;i++){const A=a.slice(i-w+1,i+1),B=b.slice(i-w+1,i+1);const ma=A.reduce((s,v)=>s+v,0)/w,mb=B.reduce((s,v)=>s+v,0)/w;let num=0,da=0,db=0;for(let j=0;j<w;j++){const xa=A[j]-ma,yb=B[j]-mb;num+=xa*yb;da+=xa*xa;db+=yb*yb;}out[i]=(da>0&&db>0)?num/Math.sqrt(da*db):null;}return out;}

    /* Dashboard */
    let globalData=[];
    const fciKey="FCI-G Index (baseline)";
    const componentKeys=["FFR","10Yr Treasury","Mortgage Rate","BBB","Stock Market","House Prices","Dollar"];

    async function loadData(){
      const res=await fetch("./data/converted.json");
      const data=await res.json(); globalData=data;
      document.getElementById("startDate").value=data[0].date;
      document.getElementById("endDate").value=data[data.length-1].date;
      drawCharts(data); updateImpact(data[0].date,data[data.length-1].date);
      initCorrelationComponent(); initSimulationComponent(); initPredCurveUI();
      enableMobileDnD(); restoreCardState();
    }

    function drawCharts(data){
      const traces1=componentKeys.map(k=>({x:data.map(d=>d.date),y:data.map(d=>+d[k]),name:k,type:"bar",opacity:0.9}));
      const fciLine={x:data.map(d=>d.date),y:data.map(d=>+d[fciKey]),mode:"lines",name:"FCI-G Index (baseline)",line:{color:"#111827",width:3}};
      Plotly.newPlot("chart1",[...traces1,fciLine],{barmode:"stack",xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Value"},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"});

      const traces1b=componentKeys.map(k=>({x:data.map(d=>d.date),y:data.map(d=>+d[k]),mode:"lines",name:k}));
      const fciLine2={x:data.map(d=>d.date),y:data.map(d=>+d[fciKey]),mode:"lines",name:"FCI-G Index (baseline)",line:{color:"#111827",width:3}};
      Plotly.newPlot("chart1b",[...traces1b,fciLine2],{xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Value"},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"});

      const percentData=data.map(d=>{const values=componentKeys.map(k=>Math.abs(+d[k]));const total=values.reduce((a,b)=>a+b,0);const shares={};componentKeys.forEach((k,i)=>{shares[k]=total>0?(values[i]/total*100):0});return{date:d.date,...shares};});
      const traces2=componentKeys.map(k=>({x:percentData.map(d=>d.date),y:percentData.map(d=>d[k]),name:k,type:"bar"}));
      Plotly.newPlot("chart2",traces2,{barmode:"stack",xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Share (%)",range:[0,100]},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"});

      const traces3=componentKeys.map(k=>({x:percentData.map(d=>d.date),y:percentData.map(d=>d[k]),mode:"lines",name:k}));
      Plotly.newPlot("chart3",traces3,{xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Share (%)",range:[0,100]},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"});
    }

    function updateImpact(startDate,endDate){
      const data=globalData.filter(d=>d.date>=startDate&&d.date<=endDate); if(data.length<2)return;
      const s=data[0], e=data[data.length-1];
      const contrib=[{component:fciKey,delta:+e[fciKey]-+s[fciKey]},...componentKeys.map(k=>({component:k,delta:+e[k]-+s[k]}))].sort((a,b)=>a.delta-b.delta);
      const trace={type:"bar",x:contrib.map(c=>c.delta),y:contrib.map(c=>c.component),orientation:"h",text:contrib.map(c=>c.delta.toFixed(3)),textposition:"outside",
        marker:{color:contrib.map(c=>c.delta>0?"rgba(220,38,38,.85)":(c.delta<0?"rgba(5,150,105,.85)":"rgba(107,114,128,.85)"))}};
      Plotly.newPlot("impactChart",[trace],{title:`Zmiana poziomu indeksu i komponentów (${s.date} → ${e.date})`,xaxis:{title:"Δ (punkty indeksowe)"},margin:{t:80,r:20,l:150,b:50}});
    }
    function quickRange(years){
      const data=globalData; if(!data.length)return; const endDate=data[data.length-1].date;
      if(years==="all"){startDate.value=data[0].date; endDateEl.value=endDate;}
      else if(years==="ytd"){const ed=new Date(endDate);const st=new Date(ed.getFullYear(),0,1);const sd=data.find(d=>new Date(d.date)>=st); startDate.value=sd?sd.date:data[0].date; endDateEl.value=endDate;}
      else{const ed=new Date(endDate);const st=new Date(ed);st.setFullYear(st.getFullYear()-years);const sd=data.find(d=>new Date(d.date)>=st); startDate.value=sd?sd.date:data[0].date; endDateEl.value=endDate;}
      applyRange();
    }
    function applyRange(){updateImpact(startDate.value,endDateEl.value)}
    const startDate=document.getElementById("startDate");
    const endDateEl=document.getElementById("endDate");

    /* Correlation component */
    function initCorrelationComponent(){
      const fciByMonth=new Map(globalData.map(d=>[toMonthKey(d.date),+d[fciKey]]));
      const joined=BTC_SERIES.filter(r=>fciByMonth.has(r.month)).map(r=>({month:r.month,fcig:fciByMonth.get(r.month),btc:r.price})).sort((a,b)=>a.month.localeCompare(b.month));
      corrFrom.value=joined[0].month; corrTo.value=joined[joined.length-1].month;
      function toChanges(arr){const out=[];for(let i=1;i<arr.length;i++){const p=arr[i-1],c=arr[i];out.push({month:c.month,d_fcig:c.fcig-p.fcig,r_btc:Math.log(c.btc/p.btc)});}return out;}
      function drawRolling(x,y){Plotly.newPlot("corrRolling3m",[{x,y,mode:"lines",name:"3M rolling"}],{title:"Korelacja krocząca 3M",yaxis:{range:[-1,1]},xaxis:{title:"Miesiąc"}});}
      function run(){
        const from=corrFrom.value, to=corrTo.value;
        let arr=joined.filter(d=>(!from||d.month>=from)&&(!to||d.month<=to));
        if(useChanges.checked){
          const ch=toChanges(arr); if(ch.length<3){corrValue.textContent="—"; drawRolling(ch.map(d=>d.month),[]); return;}
          const corr=correlation(ch.map(d=>d.d_fcig),ch.map(d=>d.r_btc)); corrValue.textContent=corr.toFixed(3);
          const roll=rollingCorrelation(ch.map(d=>d.d_fcig),ch.map(d=>d.r_btc),3); drawRolling(ch.map(d=>d.month),roll);
        }else{
          if(arr.length<3){corrValue.textContent="—"; drawRolling(arr.map(d=>d.month),[]); return;}
          const corr=correlation(arr.map(d=>d.fcig),arr.map(d=>d.btc)); corrValue.textContent=corr.toFixed(3);
          const roll=rollingCorrelation(arr.map(d=>d.fcig),arr.map(d=>d.btc),3); drawRolling(arr.map(d=>d.month),roll);
        }
      }
      corrRun.addEventListener("click",run); run();
    }

    /* Simulation */
    function initSimulationComponent(){
      const fn=(x)=> MODEL.A * Math.exp(MODEL.k * x);
      function currentRange(){const [a,b]=simRange.value.split(",").map(s=>+s.trim()); const min=Number.isFinite(a)?a:-3; const max=Number.isFinite(b)?b:3; simSlider.min=String(min); simSlider.max=String(max); return[min,max];}
      function renderPlot(sliderX){
        const [min,max]=currentRange(), steps=220; const xs=[], ys=[];
        for(let i=0;i<=steps;i++){const x=min+(max-min)*i/steps; xs.push(x); ys.push(fn(x));}
        const curve={x:xs,y:ys,mode:"lines",name:"BTC = A·e^{k·f}"};
        const point={x:[sliderX],y:[fn(sliderX)],mode:"markers",name:"Wybrany FCI-G"};
        const shapes=[]; const [aMin,aMax]=MODEL.dataRange;
        if(min<aMin)shapes.push({type:"rect",xref:"x",yref:"paper",x0:min,x1:aMin,y0:0,y1:1,fillcolor:"rgba(200,200,200,0.2)",line:{width:0}});
        if(max>aMax)shapes.push({type:"rect",xref:"x",yref:"paper",x0:aMax,x1:max,y0:0,y1:1,fillcolor:"rgba(200,200,200,0.2)",line:{width:0}});
        shapes.push({type:"line",x0:aMin,x1:aMin,y0:0,y1:1,xref:"x",yref:"paper",line:{dash:"dash",width:1}},{type:"line",x0:aMax,x1:aMax,y0:0,y1:1,xref:"x",yref:"paper",line:{dash:"dash",width:1}});
        Plotly.newPlot("simulationPlot",[curve,point],{title:"Symulacja ceny BTC dla zadanego FCI-G",xaxis:{title:"FCI-G"},yaxis:{title:"BTC (USD)",type:"log"},shapes});
      }
      function updatePoint(x){Plotly.restyle("simulationPlot",{x:[[x]],y:[[fn(x)]]},[1])}
      simRange.value="-3,3"; simSlider.value="0"; renderPlot(+simSlider.value);
      simOut.textContent = fn(+simSlider.value).toLocaleString(undefined,{maximumFractionDigits:2});
      simRange.addEventListener("change",()=>renderPlot(+simSlider.value));
      simSlider.addEventListener("input",()=>{const x=+simSlider.value; updatePoint(x); simOut.textContent=fn(x).toLocaleString(undefined,{maximumFractionDigits:2});});
    }

    /* Prediction curve */
    function renderPredictionCurve(yScale="linear"){
      const fciByMonth=new Map(globalData.map(d=>[d.date.slice(0,7),+d[fciKey]]));
      const joined=BTC_SERIES.filter(r=>fciByMonth.has(r.month)).map(r=>({f:fciByMonth.get(r.month),btc:r.price,m:r.month})).sort((a,b)=>a.f-b.f);
      const pts={x:joined.map(d=>d.f),y:joined.map(d=>d.btc),text:joined.map(d=>d.m),type:"scatter",mode:"markers",name:"Data",marker:{symbol:"x",size:9}};
      const fMin=-2,fMax=2,steps=400,fx=[],fy=[]; for(let i=0;i<=steps;i++){const f=fMin+(fMax-fMin)*i/steps; fx.push(f); fy.push(predFn(f));}
      const curve={x:fx,y:fy,type:"scatter",mode:"lines",name:"Predicted mean BTC"};
      const lx=[],ly=[],lt=[]; for(let f=fMin; f<=fMax+1e-9; f+=0.25){const ff=+f.toFixed(2); lx.push(ff); ly.push(predFn(ff)); lt.push(ff.toFixed(2));}
      const labels={x:lx,y:ly,text:lt,type:"scatter",mode:"markers+text",name:"FCI-G ticks",textposition:"top center",textfont:{size:10},marker:{size:6,opacity:.7}};
      Plotly.newPlot("plot_pred_curve",[pts,curve,labels],{title:"BTC vs FCI-G: simple prediction curve (no bands)",xaxis:{title:"FCI-G (full index)"},yaxis:{title:"Bitcoin price (USD)",type:yScale},legend:{orientation:"h"},margin:{t:60,r:20,b:50,l:60}});
    }
    function initPredCurveUI(){
      const sel=document.getElementById("pred-y-scale"); renderPredictionCurve(sel.value); sel.addEventListener("change",()=>renderPredictionCurve(sel.value));
    }

    /* Mobile-first drag & drop (Pointer Events) */
    const ORDER_KEY="fcig_cards_order";
    const COLLAPSE_KEY="fcig_cards_collapsed";
    function enableMobileDnD(){
      const container=document.getElementById("cardsContainer");
      const cards=[...container.querySelectorAll(".card")];
      cards.forEach(card=>{
        const handle=card.querySelector(".drag-handle");
        if(!handle) return;
        let dragging=false, startY=0, curY=0, placeholder=null, scrollLockY=0;

        const onMove=(clientY)=>{
          if(!dragging) return;
          curY=clientY;
          const dy=curY-startY;
          card.style.transform=`translateY(${dy}px)`;

          // find insert position
          const after=getAfterByY(container, clientY, card);
          if(after==null) container.appendChild(placeholder);
          else container.insertBefore(placeholder, after);
        };

        const pointerMove=(e)=>{ e.preventDefault(); onMove(e.clientY); };
        const touchMove=(e)=>{ if(!dragging) return; e.preventDefault(); const t=e.touches[0]; onMove(t.clientY); };

        const endDrag=()=>{
          if(!dragging) return;
          dragging=false;
          card.classList.remove("dragging");
          card.style.transition="transform .12s ease";
          card.style.transform="";
          setTimeout(()=>{ card.style.transition=""; },130);
          // place card
          if(placeholder && placeholder.parentNode){
            placeholder.parentNode.insertBefore(card, placeholder);
            placeholder.remove();
          }
          saveOrder();
          // cleanup listeners
          window.removeEventListener("pointermove", pointerMove, {passive:false});
          window.removeEventListener("pointerup", endDrag);
          window.removeEventListener("touchmove", touchMove, {passive:false});
          window.removeEventListener("touchend", endDrag);
          document.body.style.overscrollBehaviorY="";
        };

        const startDragAt=(clientY)=>{
          dragging=true;
          startY=clientY;
          card.classList.add("dragging");
          // placeholder
          placeholder=document.createElement("div");
          placeholder.className="card-placeholder";
          placeholder.style.height=card.getBoundingClientRect().height+"px";
          container.insertBefore(placeholder, card.nextSibling);
          // lock scroll bounce on iOS
          document.body.style.overscrollBehaviorY="contain";
        };

        // Support: pointer (mouse + pen), and touch (Safari)
        handle.addEventListener("pointerdown",(e)=>{
          // only left button if mouse
          if(e.pointerType==="mouse" && e.button!==0) return;
          e.preventDefault();
          startDragAt(e.clientY);
          window.addEventListener("pointermove", pointerMove, {passive:false});
          window.addEventListener("pointerup", endDrag);
        });
        // Fallback for old iOS: long-press touch
        handle.addEventListener("touchstart",(e)=>{
          const t=e.touches[0]; let longPress=true;
          const pressTimer=setTimeout(()=>{
            if(!longPress) return;
            startDragAt(t.clientY);
            window.addEventListener("touchmove", touchMove, {passive:false});
            window.addEventListener("touchend", endDrag);
          }, 120); // short press&hold
          const cancel=()=>{ longPress=false; clearTimeout(pressTimer); };
          handle.addEventListener("touchend", cancel, {once:true});
          handle.addEventListener("touchmove", (ev)=>{ if(Math.abs(ev.touches[0].clientY - t.clientY) > 6) cancel(); }, {once:true});
        }, {passive:true});
      });

      // Collapse toggle
      container.addEventListener("click",(e)=>{
        const btn=e.target.closest(".btn-collapse");
        if(!btn) return;
        const card=btn.closest(".card");
        card.classList.toggle("collapsed");
        saveCollapsed();
      });
    }

    function getAfterByY(container, y, draggingEl){
      const els=[...container.querySelectorAll(".card:not(.dragging)")];
      let closest={offset:Number.NEGATIVE_INFINITY, element:null};
      for(const el of els){
        const box=el.getBoundingClientRect();
        const offset=y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){ closest={offset, element:el}; }
      }
      return closest.element;
    }
    function saveOrder(){
      const ids=[...document.querySelectorAll("#cardsContainer .card")].map(c=>c.dataset.id);
      localStorage.setItem(ORDER_KEY, JSON.stringify(ids));
    }
    function saveCollapsed(){
      const state={}; document.querySelectorAll("#cardsContainer .card").forEach(c=> state[c.dataset.id]=c.classList.contains("collapsed"));
      localStorage.setItem(COLLAPSE_KEY, JSON.stringify(state));
    }
    function restoreCardState(){
      const container=document.getElementById("cardsContainer");
      const orderJson=localStorage.getItem(ORDER_KEY);
      if(orderJson){ try{ JSON.parse(orderJson).forEach(id=>{const el=container.querySelector(`.card[data-id="${id}"]`); if(el) container.appendChild(el); }); }catch{} }
      const collJson=localStorage.getItem(COLLAPSE_KEY);
      if(collJson){ try{ const state=JSON.parse(collJson); Object.entries(state).forEach(([id,isCol])=>{const el=container.querySelector(`.card[data-id="${id}"]`); if(el&&isCol) el.classList.add("collapsed");}); }catch{} }
    }

    // Boot
    loadData();
  </script>
<script>
/* === BTC tooltip on pure FCI-G chart === */
function drawFcigSolo(data){
  const dates = data.map(d=>d.date);
  const fci   = data.map(d=>+d[fciKey]);
  const btc   = fci.map(predFn);
  const trace = {
    x: dates, y: fci, mode:"lines", name:"FCI‑G",
    customdata: btc,
    hovertemplate: "Data: %{x}<br>FCI‑G: %{y:.3f}<br><b>BTC* (model): %{customdata:,.0f} USD</b><extra></extra>"
  };
  const invisible = {
    x:dates, y:btc, yaxis:"y2", mode:"lines", line:{width:0}, opacity:0, hoverinfo:"skip", showlegend:false
  };
  const y2range = [predFn(2.0)*0.95, predFn(-2.0)*1.05];

  Plotly.newPlot("fcigSolo",[trace, invisible],{
    margin:{t:30,r:80,b:60,l:60},
    xaxis:{title:"Data",type:"date"},
    yaxis:{title:"FCI‑G", zeroline:true},
    yaxis2:{title:"BTC (USD, model)", overlaying:"y", side:"right", tickformat:",", range:y2range, showgrid:false},
    hovermode:"x unified"
  });
  const badge = document.getElementById("fcigBadge");
  const fig   = document.getElementById("fcigSolo");
  fig.on('plotly_hover',(d)=>{ const v=d.points[0].customdata; badge.textContent="BTC*: "+v.toLocaleString(); });
  fig.on('plotly_unhover',()=>{ badge.textContent="BTC*: —"; });
}

/* Hook into existing load/draw pipeline */
const _old_drawCharts = drawCharts;
drawCharts = function(data){
  _old_drawCharts(data);
  drawFcigSolo(data);
};

/* === Theme toggle (page + Plotly) === */
(function(){
  const btn = document.getElementById("themeToggle");
  const root = document.documentElement;
  const ids = ["chart1","chart1b","chart2","chart3","impactChart","corrRolling3m","simulationPlot","plot_pred_curve","fcigSolo"];
  function applyTheme(t){
    root.classList.toggle("dark", t==="dark");
    localStorage.setItem("theme", t);
    const isDark = t==="dark";
    const paper = getComputedStyle(root).getPropertyValue("--card-bg").trim();
    const fg    = getComputedStyle(root).getPropertyValue("--fg").trim();
    const grid  = getComputedStyle(root).getPropertyValue("--border").trim();
    ids.forEach(id=>{
      const div=document.getElementById(id);
      if(!div) return;
      Plotly.relayout(id, {
        paper_bgcolor: paper, plot_bgcolor: paper,
        "font.color": fg,
        "xaxis.gridcolor": grid, "yaxis.gridcolor": grid
      });
    });
  }
  const saved = localStorage.getItem("theme") || "light";
  applyTheme(saved);
  btn.addEventListener("click", ()=>{
    const next = (document.documentElement.classList.contains("dark")) ? "light":"dark";
    applyTheme(next);
  });
})();
</script><script>
// === Ensure globals from existing page ===
window.predFn = window.predFn || (f => {
  // fallback: simple BTC model (must be overwritten by main script if defined there)
  const alpha = 10.996496662385686, beta = -1.1403503021295252, S = 1.0238973190689769;
  return S * Math.exp(alpha + beta*f);
});
window.fciKey = window.fciKey || "FCI_G";

function drawFcigSolo(data){
  try {
    const dates = data.map(d=>d.date || d.observation_date || d.Date || d[Object.keys(d)[0]]);
    const fci   = data.map(d=>+d[window.fciKey]);
    const btc   = fci.map(window.predFn);
    const trace = {
      x: dates, y: fci, mode:"lines", name:"FCI‑G",
      customdata: btc,
      hovertemplate: "Data: %{x}<br>FCI‑G: %{y:.3f}<br><b>BTC* (model): %{customdata:,.0f} USD</b><extra></extra>"
    };
    const invisible = {
      x:dates, y:btc, yaxis:"y2", mode:"lines", line:{width:0}, opacity:0, hoverinfo:"skip", showlegend:false
    };
    const y2range = [window.predFn(2.0)*0.95, window.predFn(-2.0)*1.05];
    Plotly.newPlot("fcigSolo",[trace, invisible],{
      margin:{t:30,r:80,b:60,l:60},
      xaxis:{title:"Data",type:"date"},
      yaxis:{title:"FCI‑G", zeroline:true},
      yaxis2:{title:"BTC (USD, model)", overlaying:"y", side:"right", tickformat:",", range:y2range, showgrid:false},
      hovermode:"x unified"
    });
    const badge = document.getElementById("fcigBadge");
    const fig   = document.getElementById("fcigSolo");
    fig.on('plotly_hover',(d)=>{ const v=d.points[0].customdata; badge.textContent="BTC*: "+new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(v)+" USD"; });
    fig.on('plotly_unhover',()=>{ badge.textContent="BTC*: —"; });
  } catch(e){ console.error("drawFcigSolo error", e); }
}

// Hook into existing drawCharts if present
(function(){
  const old = window.drawCharts;
  window.drawCharts = function(data){
    try{ if(typeof old === "function") old(data); }catch(e){ console.warn(e); }
    try{ drawFcigSolo(data); }catch(e){ console.warn(e); }
  }
})();

// Theme toggle for entire page + Plotly charts
(function(){
  const btn = document.getElementById("themeToggle");
  const root = document.documentElement;
  const ids = ["chart1","chart1b","chart2","chart3","impactChart","corrRolling3m","simulationPlot","plot_pred_curve","fcigSolo"];
  function applyTheme(t){
    root.classList.toggle("dark", t==="dark");
    localStorage.setItem("theme", t);
    const paper = getComputedStyle(root).getPropertyValue("--card-bg") || getComputedStyle(root).getPropertyValue("--bg");
    const fg    = getComputedStyle(root).getPropertyValue("--fg");
    const grid  = getComputedStyle(root).getPropertyValue("--border") || "#e5e7eb";
    ids.forEach(id=>{
      const div=document.getElementById(id);
      if(!div) return;
      Plotly.relayout(id, {
        paper_bgcolor: paper.trim(), plot_bgcolor: paper.trim(),
        "font.color": fg.trim(),
        "xaxis.gridcolor": grid.trim(), "yaxis.gridcolor": grid.trim()
      });
    });
  }
  const saved = localStorage.getItem("theme") || "light";
  applyTheme(saved);
  if(btn){
    btn.addEventListener("click", ()=>{
      const next = (document.documentElement.classList.contains("dark")) ? "light":"dark";
      applyTheme(next);
    });
  }
})();
</script><footer id="siteFooter" style="margin-top:18px;padding:12px 0;color:#6b7280;font-size:13px;text-align:center;border-top:1px solid var(--border)">Źródło opisu FCI‑G: <a href="https://www.federalreserve.gov/econres/notes/feds-notes/a-new-index-to-measure-us-financial-conditions-20230630.html" rel="noopener" target="_blank">FEDS Notes — A New Index to Measure U.S. Financial Conditions</a></footer></body>
</html>
