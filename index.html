<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>FCI-G Dashboard (Mobile-first)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <!-- Plotly (deferred to avoid blocking the parser; executes before our inline script) -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
  <style>
    :root{
      --card-bg:#fff; --bg:#f7fafc; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 10px 25px rgba(0,0,0,0.08);
      --pad:14px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --card-bg:#0b1220; --bg:#0a0f1a; --text:#e5e7eb; --muted:#9ca3af;
        --border:#1f2937; --shadow:0 10px 25px rgba(0,0,0,0.40);
      }
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      padding:12px;
    }
    #status{
      width:100%;
      max-width:1000px;
      background:#fffbe6;
      color:#7c5e10;
      border:1px solid #facc15;
      padding:10px 12px;
      border-radius:10px;
      display:none;
    }
    #status.error{ background:#fef2f2; color:#991b1b; border-color:#fecaca }
    #cardsContainer{
      width:100%;
      max-width:1000px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background:var(--card-bg);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      touch-action: manipulation; /* keep taps snappy */
      position: relative; /* ensure z-index works while dragging */
    }
    .card.dragging{
      opacity:.95;
      z-index: 5;
    }
    .card-placeholder{
      border:2px dashed #cbd5e1;
      border-radius:16px;
      background: #f1f5f9;
      height:60px;
      margin:0;
    }
    .card-header{
      display:flex; align-items:center; gap:10px;
      padding: var(--pad);
      background:#f1f5f9;
      border-bottom:1px solid var(--border);
      user-select:none;
    }
    .card-header h2{
      margin:0; font-size:16px; line-height:1.2; flex:1; font-weight:600;
    }
    .card-controls{display:flex; gap:8px; align-items:center;}
    .btn, .drag-handle{
      border:1px solid #d1d5db; background:#fff;
      border-radius:10px; padding:6px 10px; font-size:13px; cursor:pointer;
    }
    .btn:active, .drag-handle:active{transform: scale(0.98)}
    .btn:focus-visible, .drag-handle:focus-visible{ outline: 2px solid #3b82f6; outline-offset: 2px }
    .drag-handle{font-weight:700; cursor:grab; touch-action:none;}
    .card-body{padding: var(--pad); background:var(--card-bg);}
    .card.collapsed .card-body{display:none}
    .card.collapsed .btn-collapse::after{content:"▸"}
    .btn-collapse::after{content:"▾"}

    /* Charts sizing: mobile-first */
    #chart1,#chart1b,#chart2,#chart3,#impactChart{width:100%; height:420px}
    #corrRolling3m,#simulationPlot,#plot_pred_curve{width:100%; height:360px}

    .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px}
    .controls input, .controls select, .controls button{
      padding:6px 9px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:14px
    }

    /* Larger screens */
    @media (min-width: 700px){
      :root{--pad:16px}
      #chart1,#chart1b,#chart2,#chart3,#impactChart{height:520px}
      #corrRolling3m,#simulationPlot,#plot_pred_curve{height:420px}
      .card-header h2{font-size:18px}
    }
  </style>
</head>
<body>

  <div id="status" role="status" aria-live="polite"></div>

  <div id="cardsContainer">
    <section class="card" data-id="card-about">
      <div class="card-header">
        <h2>Co mierzy FCI-G?</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body" style="line-height:1.5">
        <p style="margin:0 0 8px">
          <strong>FCI-G</strong> to indeks warunków finansowych opracowany przez FED.
          Łączy siedem zmiennych: stopę funduszy federalnych, rentowność 10-letnich UST, 30-letnią stopę hipoteczną,
          spread obligacji korporacyjnych BBB, szeroki indeks akcji, ceny domów oraz nominalny szeroki indeks USD.
          Wagi pochodzą z modeli (m.in. FRB/US) i odzwierciedlają łączny wpływ <em>trwałej</em> zmiany tych zmiennych
          na wzrost PKB w kolejnym roku — dzięki czemu indeks interpretuje warunki jako dodające do wzrostu PKB (wartości ujemne)
          lub odejmujące od wzrostu PKB (dodatnie) dla aktywności gospodarczej.
        </p>
        <p style="margin:0;color:#6b7280">
          Źródło: FEDS Notes, „A New Index to Measure U.S. Financial Conditions”
          (<a href="https://www.federalreserve.gov/econres/notes/feds-notes/a-new-index-to-measure-us-financial-conditions-20230630.html" target="_blank" rel="noopener">link</a>).
        </p>
      </div>
    </section>

    <section class="card" data-id="card-stacked">
      <div class="card-header">
        <h2>Financial Conditions (Stacked Bars + FCI-G)</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body"><div id="chart1"></div></div>
    </section>

    <section class="card" data-id="card-lines">
      <div class="card-header">
        <h2>Komponenty i FCI-G (linie)</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body"><div id="chart1b"></div></div>
    </section>

    <section class="card" data-id="card-shares">
      <div class="card-header">
        <h2>Procentowy udział komponentów w FCI-G</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body"><div id="chart2"></div></div>
    </section>

    <section class="card" data-id="card-history-shares">
      <div class="card-header">
        <h2>Historyczne udziały komponentów</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body"><div id="chart3"></div></div>
    </section>

    <section class="card" data-id="card-impact">
      <div class="card-header">
        <h2>Zmiany komponentów i indeksu w wybranym okresie</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body">
        <div class="controls">
          <label>Od: <input type="date" id="startDate" /></label>
          <label>Do: <input type="date" id="endDate" /></label>
          <button id="btnApplyRange">Zastosuj</button>
          <button data-quick="ytd">YTD</button>
          <button data-quick="1">1Y</button>
          <button data-quick="3">3Y</button>
          <button data-quick="5">5Y</button>
          <button data-quick="all">All</button>
        </div>
        <div id="impactChart"></div>
      </div>
    </section>

    <section class="card" data-id="card-corr">
      <div class="card-header">
        <h2>FCI-G ↔ BTC — korelacja i 3M rolling (miesięcznie)</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body">
        <div class="controls">
          <label>Od: <input type="month" id="corrFrom" /></label>
          <label>Do: <input type="month" id="corrTo" /></label>
          <label style="display:flex;gap:6px;align-items:center;">
            <input type="checkbox" id="useChanges" checked /> Użyj zmian (ΔFCI-G vs log-zwroty BTC)
          </label>
          <button id="corrRun">Oblicz korelację</button>
          <div><strong>Wynik:</strong> <span id="corrValue" aria-live="polite">—</span></div>
        </div>
        <div id="corrRolling3m"></div>
      </div>
    </section>

    <section class="card" data-id="card-sim">
      <div class="card-header">
        <h2>Symulacja: BTC = S · e<sup>α + β·FCI_G</sup></h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body">
        <div class="controls">
          <label>Zakres FCI-G (min,max): <input type="text" id="simRange" value="-3,3" inputmode="decimal" /></label>
          <label>FCI-G: <input type="range" id="simSlider" min="-3" max="3" step="0.01" value="0" /></label>
          <div><strong>BTC:</strong> <span id="simOut">—</span></div>
          <div style="opacity:.8">Zakres danych: <code>[-0.78, 1.00]</code> — poza nim (zacienienie) to ekstrapolacja.</div>
        </div>
        <div id="simulationPlot"></div>
      </div>
    </section>

    <section class="card" data-id="card-predcurve">
      <div class="card-header">
        <h2>BTC vs FCI-G: Simple Prediction Curve (No Bands)</h2>
        <div class="card-controls">
          <button class="btn btn-collapse" title="Zwiń/rozwiń" aria-label="Zwiń/rozwiń kartę" aria-expanded="true"></button>
          <div class="drag-handle" title="Przeciągnij (przytrzymaj)" role="button" tabindex="0" aria-grabbed="false">⋮⋮</div>
        </div>
      </div>
      <div class="card-body">
        <div class="controls">
          <label>Skala Y:
            <select id="pred-y-scale">
              <option value="linear">linear</option>
              <option value="log">log</option>
            </select>
          </label>
          <small style="opacity:.8">Model: BTC(f) = A·e^{k·f}, A=61090.941, k=−1.14035</small>
        </div>
        <div id="plot_pred_curve"></div>
      </div>
    </section>
  </div>

  <script>
  (() => {
    'use strict';

    /* =========================
       Dane wbudowane + model
       ========================= */
    const BTC_SERIES = [
      { month: "2022-09", price: 19415.8 },
      { month: "2022-10", price: 20472.79 },
      { month: "2022-11", price: 17179.78 },
      { month: "2022-12", price: 16531.0 },
      { month: "2023-01", price: 23134.74 },
      { month: "2023-02", price: 23146.93 },
      { month: "2023-03", price: 28492.72 },
      { month: "2023-04", price: 29271.16 },
      { month: "2023-05", price: 27222.9 },
      { month: "2023-06", price: 30475.82 },
      { month: "2023-07", price: 29223.31 },
      { month: "2023-08", price: 25922.51 },
      { month: "2023-09", price: 26959.4 },
      { month: "2023-10", price: 34667.88 },
      { month: "2023-11", price: 37743.0 },
      { month: "2023-12", price: 42300.78 },
      { month: "2024-01", price: 42599.49 },
      { month: "2024-02", price: 61240.13 },
      { month: "2024-03", price: 71213.11 },
      { month: "2024-04", price: 60690.8 },
      { month: "2024-05", price: 67506.03 },
      { month: "2024-06", price: 62678.1 },
      { month: "2024-07", price: 64607.71 },
      { month: "2024-08", price: 58956.52 },
      { month: "2024-09", price: 60790.0 },
      { month: "2024-10", price: 69467.29 },
      { month: "2024-11", price: 97263.18 },
      { month: "2024-12", price: 94383.59 },
      { month: "2025-01", price: 100623.85 },
      { month: "2025-02", price: 86018.76 },
      { month: "2025-03", price: 85170.37 },
      { month: "2025-04", price: 96524.98 },
      { month: "2025-05", price: 105697.94 },
      { month: "2025-06", price: 105711.78 },
      { month: "2025-07", price: 113248.73 }
    ];
    const MODEL = { A: 61090.941, k: -1.14035, dataRange: [-0.78, 1.00] };
    const predFn = (f) => MODEL.A * Math.exp(MODEL.k * f);

    /* Helpers */
    const $ = (id) => document.getElementById(id);
    const toMonthKey = (iso) => iso.split("-").slice(0,2).join("-");
    function showStatus(msg, type="info"){
      const el = $("status");
      el.textContent = msg;
      el.className = type === "error" ? "error" : "";
      el.style.display = msg ? "block" : "none";
    }
    function correlation(x,y){
      const n=x.length, mx=x.reduce((s,v)=>s+v,0)/n, my=y.reduce((s,v)=>s+v,0)/n;
      let num=0,dx=0,dy=0; for(let i=0;i<n;i++){const xa=x[i]-mx, yb=y[i]-my; num+=xa*yb; dx+=xa*xa; dy+=yb*yb;}
      return (dx>0 && dy>0) ? num/Math.sqrt(dx*dy) : NaN;
    }
    function rollingCorrelation(a,b,w){
      const out=new Array(a.length).fill(null);
      for(let i=w-1;i<a.length;i++){
        const A=a.slice(i-w+1,i+1), B=b.slice(i-w+1,i+1);
        const ma=A.reduce((s,v)=>s+v,0)/w, mb=B.reduce((s,v)=>s+v,0)/w;
        let num=0,da=0,db=0; for(let j=0;j<w;j++){const xa=A[j]-ma, yb=B[j]-mb; num+=xa*yb; da+=xa*xa; db+=yb*yb;}
        out[i]=(da>0&&db>0)?num/Math.sqrt(da*db):null;
      }
      return out;
    }
    function parseISO(s){ return s; } // dates are ISO yyyy-mm-dd; string compare works

    /* Shared Plotly config */
    const PLOT_CONFIG = { responsive: true, displaylogo: false };

    /* Dashboard */
    let globalData=[];
    const fciKey="FCI-G Index (baseline)";
    const componentKeys=["FFR","10Yr Treasury","Mortgage Rate","BBB","Stock Market","House Prices","Dollar"];

    async function loadData(){
      try{
        showStatus("Wczytuję dane…");
        const res=await fetch("./data/converted.json", { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json(); globalData=data;
        showStatus(""); // clear banner

        // Set initial range
        $("startDate").value=data[0].date;
        $("endDate").value=data[data.length-1].date;

        drawCharts(data);
        updateImpact(data[0].date,data[data.length-1].date);
        initCorrelationComponent();
        initSimulationComponent();
        initPredCurveUI();
        enableMobileDnD();
        restoreCardState();
        initA11y();
        bindRangeButtons();
      }catch(err){
        console.error(err);
        showStatus("Nie udało się wczytać danych (data/converted.json). Sprawdź ścieżkę lub uprawnienia.", "error");
      }
    }

    function drawCharts(data){
      const xDates = data.map(d=>d.date);
      const traces1=componentKeys.map(k=>({x:xDates,y:data.map(d=>+d[k]),name:k,type:"bar",opacity:0.9}));
      const fciLine={x:xDates,y:data.map(d=>+d[fciKey]),mode:"lines",name:"FCI-G Index (baseline)",line:{color:"#111827",width:3}};
      Plotly.newPlot("chart1",[...traces1,fciLine],{barmode:"stack",xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Value"},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"}, PLOT_CONFIG);

      const traces1b=componentKeys.map(k=>({x:xDates,y:data.map(d=>+d[k]),mode:"lines",name:k}));
      const fciLine2={x:xDates,y:data.map(d=>+d[fciKey]),mode:"lines",name:"FCI-G Index (baseline)",line:{color:"#111827",width:3}};
      Plotly.newPlot("chart1b",[...traces1b,fciLine2],{xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Value"},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"}, PLOT_CONFIG);

      const percentData=data.map(d=>{
        const values=componentKeys.map(k=>Math.abs(+d[k]));
        const total=values.reduce((a,b)=>a+b,0);
        const shares={}; componentKeys.forEach((k,i)=>{shares[k]=total>0?(values[i]/total*100):0});
        return{date:d.date,...shares};
      });
      const traces2=componentKeys.map(k=>({x:percentData.map(d=>d.date),y:percentData.map(d=>d[k]),name:k,type:"bar"}));
      Plotly.newPlot("chart2",traces2,{barmode:"stack",xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Share (%)",range:[0,100]},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"}, PLOT_CONFIG);

      const traces3=componentKeys.map(k=>({x:percentData.map(d=>d.date),y:percentData.map(d=>d[k]),mode:"lines",name:k}));
      Plotly.newPlot("chart3",traces3,{xaxis:{tickangle:-45,automargin:true},yaxis:{title:"Share (%)",range:[0,100]},legend:{orientation:"h",y:-0.3},margin:{t:40,r:20,l:50,b:100},hovermode:"x unified"}, PLOT_CONFIG);
    }

    function updateImpact(startDate,endDate){
      const data=globalData.filter(d=>parseISO(d.date)>=parseISO(startDate)&&parseISO(d.date)<=parseISO(endDate));
      if(data.length<2)return;
      const s=data[0], e=data[data.length-1];
      const contrib=[{component:fciKey,delta:+e[fciKey]-+s[fciKey]},...componentKeys.map(k=>({component:k,delta:+e[k]-+s[k]}))].sort((a,b)=>a.delta-b.delta);
      const trace={type:"bar",x:contrib.map(c=>c.delta),y:contrib.map(c=>c.component),orientation:"h",
        text:contrib.map(c=>c.delta.toFixed(3)),textposition:"auto",
        marker:{color:contrib.map(c=>c.delta>0?"rgba(220,38,38,.85)":(c.delta<0?"rgba(5,150,105,.85)":"rgba(107,114,128,.85)"))}};
      Plotly.newPlot("impactChart",[trace],{title:`Zmiana poziomu indeksu i komponentów (${s.date} → ${e.date})`,xaxis:{title:"Δ (punkty indeksowe)"},margin:{t:80,r:20,l:150,b:50}}, PLOT_CONFIG);
    }

    function quickRange(years){
      const data=globalData; if(!data.length)return; const endDate=data[data.length-1].date;
      const startInput = $("startDate");
      const endInput = $("endDate");
      if(years==="all"){startInput.value=data[0].date; endInput.value=endDate;}
      else if(years==="ytd"){
        const st = endDate.slice(0,4)+"-01-01";
        const sd=data.find(d=>d.date>=st);
        startInput.value=sd?sd.date:data[0].date; endInput.value=endDate;
      }else{
        const edYear = parseInt(endDate.slice(0,4), 10);
        const st = (edYear-years)+"-"+endDate.slice(5);
        const sd=data.find(d=>d.date>=st);
        startInput.value=sd?sd.date:data[0].date; endInput.value=endDate;
      }
      applyRange();
    }

    function bindRangeButtons(){
      $("btnApplyRange").addEventListener("click", applyRange);
      document.querySelectorAll('[data-quick]').forEach(btn=>{
        btn.addEventListener('click', ()=> quickRange(btn.dataset.quick));
      });
    }

    function applyRange(){ updateImpact($("startDate").value, $("endDate").value); }

    /* Correlation component */
    function initCorrelationComponent(){
      const corrFrom=$("corrFrom");
      const corrTo=$("corrTo");
      const useChanges=$("useChanges");
      const corrRun=$("corrRun");
      const corrValue=$("corrValue");

      const fciByMonth=new Map(globalData.map(d=>[toMonthKey(d.date),+d[fciKey]]));
      const joined=BTC_SERIES.filter(r=>fciByMonth.has(r.month)).map(r=>({month:r.month,fcig:fciByMonth.get(r.month),btc:r.price})).sort((a,b)=>a.month.localeCompare(b.month));
      corrFrom.value=joined[0].month; corrTo.value=joined[joined.length-1].month;

      function toChanges(arr){const out=[];for(let i=1;i<arr.length;i++){const p=arr[i-1],c=arr[i];out.push({month:c.month,d_fcig:c.fcig-p.fcig,r_btc:Math.log(c.btc/p.btc)});}return out;}
      function drawRolling(x,y){Plotly.newPlot("corrRolling3m",[{x,y,mode:"lines",name:"3M rolling"}],{title:"Korelacja krocząca 3M",yaxis:{range:[-1,1]},xaxis:{title:"Miesiąc"}}, PLOT_CONFIG);}
      function run(){
        const from=corrFrom.value, to=corrTo.value;
        let arr=joined.filter(d=>(!from||d.month>=from)&&(!to||d.month<=to));
        if(useChanges.checked){
          const ch=toChanges(arr); if(ch.length<3){corrValue.textContent="—"; drawRolling(ch.map(d=>d.month),[]); return;}
          const corr=correlation(ch.map(d=>d.d_fcig),ch.map(d=>d.r_btc)); corrValue.textContent=isFinite(corr)?corr.toFixed(3):"—";
          const roll=rollingCorrelation(ch.map(d=>d.d_fcig),ch.map(d=>d.r_btc),3); drawRolling(ch.map(d=>d.month),roll);
        }else{
          if(arr.length<3){corrValue.textContent="—"; drawRolling(arr.map(d=>d.month),[]); return;}
          const corr=correlation(arr.map(d=>d.fcig),arr.map(d=>d.btc)); corrValue.textContent=isFinite(corr)?corr.toFixed(3):"—";
          const roll=rollingCorrelation(arr.map(d=>d.fcig),arr.map(d=>d.btc),3); drawRolling(arr.map(d=>d.month),roll);
        }
      }
      corrRun.addEventListener("click",run); run();
    }

    /* Simulation */
    function initSimulationComponent(){
      const simRange = $("simRange");
      const simSlider = $("simSlider");
      const simOut = $("simOut");
      const fn=(x)=> MODEL.A * Math.exp(MODEL.k * x);
      function currentRange(){
        const [a,b]=simRange.value.split(",").map(s=>+s.trim());
        const min=Number.isFinite(a)?a:-3; const max=Number.isFinite(b)?b:3;
        simSlider.min=String(min); simSlider.max=String(max); return[min,max];
      }
      function renderPlot(sliderX){
        const [min,max]=currentRange(), steps=220; const xs=[], ys=[];
        for(let i=0;i<=steps;i++){const x=min+(max-min)*i/steps; xs.push(x); ys.push(fn(x));}
        const curve={x:xs,y:ys,mode:"lines",name:"BTC = A·e^{k·f}"};
        const point={x:[sliderX],y:[fn(sliderX)],mode:"markers",name:"Wybrany FCI-G"};
        const shapes=[]; const [aMin,aMax]=MODEL.dataRange;
        if(min<aMin)shapes.push({type:"rect",xref:"x",yref:"paper",x0:min,x1:aMin,y0:0,y1:1,fillcolor:"rgba(200,200,200,0.2)",line:{width:0}});
        if(max>aMax)shapes.push({type:"rect",xref:"x",yref:"paper",x0:aMax,x1:max,y0:0,y1:1,fillcolor:"rgba(200,200,200,0.2)",line:{width:0}});
        shapes.push({type:"line",x0:aMin,x1:aMin,y0:0,y1:1,xref:"x",yref:"paper",line:{dash:"dash",width:1}},{type:"line",x0:aMax,x1:aMax,y0:0,y1:1,xref:"x",yref:"paper",line:{dash:"dash",width:1}});
        Plotly.newPlot("simulationPlot",[curve,point],{title:"Symulacja ceny BTC dla zadanego FCI-G",xaxis:{title:"FCI-G"},yaxis:{title:"BTC (USD)",type:"log"},shapes}, PLOT_CONFIG);
      }
      function updatePoint(x){Plotly.restyle("simulationPlot",{x:[[x]],y:[[fn(x)]]},[1])}
      simRange.value="-3,3"; simSlider.value="0"; renderPlot(+simSlider.value);
      simOut.textContent = fn(+simSlider.value).toLocaleString(undefined,{maximumFractionDigits:2});
      simRange.addEventListener("change",()=>renderPlot(+simSlider.value));
      simSlider.addEventListener("input",()=>{const x=+simSlider.value; updatePoint(x); simOut.textContent=fn(x).toLocaleString(undefined,{maximumFractionDigits:2});});
    }

    /* Prediction curve */
    function renderPredictionCurve(yScale="linear"){
      const fciByMonth=new Map(globalData.map(d=>[d.date.slice(0,7),+d[fciKey]]));
      const joined=BTC_SERIES.filter(r=>fciByMonth.has(r.month)).map(r=>({f:fciByMonth.get(r.month),btc:r.price,m:r.month})).sort((a,b)=>a.f-b.f);
      const pts={x:joined.map(d=>d.f),y:joined.map(d=>d.btc),text:joined.map(d=>d.m),type:"scatter",mode:"markers",name:"Data",marker:{symbol:"x",size:9}};
      const fMin=-2,fMax=2,steps=400,fx=[],fy=[]; for(let i=0;i<=steps;i++){const f=fMin+(fMax-fMin)*i/steps; fx.push(f); fy.push(predFn(f));}
      const curve={x:fx,y:fy,type:"scatter",mode:"lines",name:"Predicted mean BTC"};
      const lx=[],ly=[],lt=[]; for(let f=fMin; f<=fMax+1e-9; f+=0.25){const ff=+f.toFixed(2); lx.push(ff); ly.push(predFn(ff)); lt.push(ff.toFixed(2));}
      const labels={x:lx,y:ly,text:lt,type:"scatter",mode:"markers+text",name:"FCI-G ticks",textposition:"top center",textfont:{size:10},marker:{size:6,opacity:.7}};
      Plotly.newPlot("plot_pred_curve",[pts,curve,labels],{title:"BTC vs FCI-G: simple prediction curve (no bands)",xaxis:{title:"FCI-G (full index)"},yaxis:{title:"Bitcoin price (USD)",type:yScale},legend:{orientation:"h"},margin:{t:60,r:20,b:50,l:60}}, PLOT_CONFIG);
    }
    function initPredCurveUI(){
      const sel=$("pred-y-scale"); renderPredictionCurve(sel.value); sel.addEventListener("change",()=>renderPredictionCurve(sel.value));
    }

    /* Mobile-first drag & drop (Pointer Events) */
    const ORDER_KEY="fcig_cards_order";
    const COLLAPSE_KEY="fcig_cards_collapsed";
    const LONG_PRESS_MS = 220;
    function enableMobileDnD(){
      const container=document.getElementById("cardsContainer");
      const cards=[...container.querySelectorAll(".card")];
      cards.forEach(card=>{
        const handle=card.querySelector(".drag-handle");
        if(!handle) return;
        let dragging=false, startY=0, curY=0, placeholder=null;

        const onMove=(clientY)=>{
          if(!dragging) return;
          curY=clientY;
          const dy=curY-startY;
          card.style.transform=`translateY(${dy}px)`;
          const after=getAfterByY(container, clientY, card);
          if(after==null) container.appendChild(placeholder);
          else container.insertBefore(placeholder, after);
        };

        const pointerMove=(e)=>{ e.preventDefault(); onMove(e.clientY); };
        const touchMove=(e)=>{ if(!dragging) return; e.preventDefault(); const t=e.touches[0]; onMove(t.clientY); };

        const endDrag=()=>{
          if(!dragging) return;
          dragging=false;
          handle.setAttribute("aria-grabbed","false");
          card.classList.remove("dragging");
          card.style.transition="transform .12s ease";
          card.style.transform="";
          setTimeout(()=>{ card.style.transition=""; },130);
          if(placeholder && placeholder.parentNode){
            placeholder.parentNode.insertBefore(card, placeholder);
            placeholder.remove();
          }
          saveOrder();
          window.removeEventListener("pointermove", pointerMove, {passive:false});
          window.removeEventListener("pointerup", endDrag);
          window.removeEventListener("pointercancel", endDrag);
          window.removeEventListener("touchmove", touchMove, {passive:false});
          window.removeEventListener("touchend", endDrag);
          document.body.style.overscrollBehaviorY="";
        };

        const startDragAt=(clientY)=>{
          dragging=true;
          startY=clientY;
          handle.setAttribute("aria-grabbed","true");
          card.classList.add("dragging");
          placeholder=document.createElement("div");
          placeholder.className="card-placeholder";
          placeholder.style.height=card.getBoundingClientRect().height+"px";
          container.insertBefore(placeholder, card.nextSibling);
          document.body.style.overscrollBehaviorY="contain";
        };

        handle.addEventListener("pointerdown",(e)=>{
          if(e.pointerType==="mouse" && e.button!==0) return;
          e.preventDefault();
          startDragAt(e.clientY);
          window.addEventListener("pointermove", pointerMove, {passive:false});
          window.addEventListener("pointerup", endDrag);
          window.addEventListener("pointercancel", endDrag);
        });

        // Fallback for old iOS: long-press touch
        handle.addEventListener("touchstart",(e)=>{
          const t=e.touches[0]; let longPress=true;
          const pressTimer=setTimeout(()=>{
            if(!longPress) return;
            startDragAt(t.clientY);
            window.addEventListener("touchmove", touchMove, {passive:false});
            window.addEventListener("touchend", endDrag);
          }, LONG_PRESS_MS);
          const cancel=()=>{ longPress=false; clearTimeout(pressTimer); };
          handle.addEventListener("touchend", cancel, {once:true});
          handle.addEventListener("touchmove", (ev)=>{ if(Math.abs(ev.touches[0].clientY - t.clientY) > 6) cancel(); }, {once:true});
        }, {passive:true});
      });

      // Collapse toggle (and a11y sync)
      container.addEventListener("click",(e)=>{
        const btn=e.target.closest(".btn-collapse");
        if(!btn) return;
        const card=btn.closest(".card");
        const collapsed = card.classList.toggle("collapsed");
        btn.setAttribute("aria-expanded", String(!collapsed));
        saveCollapsed();
      });
    }

    function initA11y(){
      document.querySelectorAll("#cardsContainer .card").forEach((card, idx)=>{
        const body = card.querySelector(".card-body");
        const btn = card.querySelector(".btn-collapse");
        if(body && btn){
          if(!body.id){ body.id = (card.dataset.id ? card.dataset.id : "card-"+idx) + "-body"; }
          btn.setAttribute("aria-controls", body.id);
          btn.setAttribute("aria-expanded", String(!card.classList.contains("collapsed")));
        }
      });
    }

    function getAfterByY(container, y, draggingEl){
      const els=[...container.querySelectorAll(".card:not(.dragging)")];
      let closest={offset:Number.NEGATIVE_INFINITY, element:null};
      for(const el of els){
        const box=el.getBoundingClientRect();
        const offset=y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){ closest={offset, element:el}; }
      }
      return closest.element;
    }
    function saveOrder(){
      const ids=[...document.querySelectorAll("#cardsContainer .card")].map(c=>c.dataset.id);
      localStorage.setItem(ORDER_KEY, JSON.stringify(ids));
    }
    function saveCollapsed(){
      const state={}; document.querySelectorAll("#cardsContainer .card").forEach(c=> state[c.dataset.id]=c.classList.contains("collapsed"));
      localStorage.setItem(COLLAPSE_KEY, JSON.stringify(state));
    }
    function restoreCardState(){
      const container=document.getElementById("cardsContainer");
      const orderJson=localStorage.getItem(ORDER_KEY);
      if(orderJson){ try{ JSON.parse(orderJson).forEach(id=>{const el=container.querySelector(\`.card[data-id="\${id}"]\`); if(el) container.appendChild(el); }); }catch{} }
      const collJson=localStorage.getItem(COLLAPSE_KEY);
      if(collJson){ try{ const state=JSON.parse(collJson); Object.entries(state).forEach(([id,isCol])=>{const el=container.querySelector(\`.card[data-id="\${id}"]\`); if(el){ el.classList.toggle("collapsed", !!isCol); const btn = el.querySelector(".btn-collapse"); if(btn) btn.setAttribute("aria-expanded", String(!isCol)); }}); }catch{} }
    }

    // Boot once DOM ready (Plotly is deferred and will have executed)
    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", loadData);
    }else{
      loadData();
    }
  })();
  </script>
</body>
</html>
