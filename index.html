<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FCI-G Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #eef2ff, #e0f2fe);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      padding: 20px 30px;
      max-width: 1200px;
      width: 100%;
      position: relative;
    }
    #chart { width: 100%; height: 700px; } /* większa wysokość */
    h2 { margin: 0 0 10px; color: #111827; }
    p { margin: 0 0 20px; color: #6b7280; }

    /* Drawer */
    .drawer-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      display: none;
      z-index: 999;
    }
    .drawer {
      position: fixed;
      top: 0; right: -340px;
      width: 320px;
      height: 100%;
      background: #fff;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
    }
    .drawer.open { right: 0; }
    .drawer-overlay.active { display: block; }
    .drawer h3 { margin-top: 0; }
    .drawer section { margin-bottom: 20px; }
    .drawer button, .drawer select, .drawer input {
      display: block;
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      width: 100%;
      font-size: 14px;
    }
    .drawer button.active {
      background: #6366f1;
      color: white;
      border-color: #6366f1;
    }

    /* Toggle button */
    .toggle-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #6366f1;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    /* Serie pod wykresem */
    .series-panel {
      margin-top: 20px;
      padding: 10px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .series-panel label {
      display: flex;
      align-items: center;
      font-size: 14px;
      cursor: pointer;
    }
    .series-panel input {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Financial Conditions Chart</h2>
    <p>Interactive chart with side panel and custom series</p>
    <button class="toggle-btn" onclick="openDrawer()">⚙️ Settings</button>
    <div id="chart"></div>

    <!-- Serie pod wykresem -->
    <div class="series-panel" id="series-list"></div>
  </div>

  <!-- Drawer -->
  <div id="drawer-overlay" class="drawer-overlay" onclick="closeDrawer()"></div>
  <div id="drawer" class="drawer">
    <h3>Chart Settings</h3>

    <section>
      <h4>Mode</h4>
      <button id="mode-lines" class="active">Lines</button>
      <button id="mode-stacked">Stacked Area</button>
      <button id="mode-diff">Diff (FFR - Treasury)</button>
    </section>

    <section>
      <h4>Time Range</h4>
      <button id="range-all" class="active">All</button>
      <button id="range-10y">Last 10y</button>
      <button id="range-5y">Last 5y</button>
      <button id="range-3y">Last 3y</button>
    </section>

    <section>
      <h4>Create Custom Series</h4>
      <select id="col1"></select>
      <select id="operation">
        <option value="+">+</option>
        <option value="-">-</option>
        <option value="*">×</option>
        <option value="/">÷</option>
      </select>
      <select id="col2"></select>
      <input id="seriesName" type="text" placeholder="Series name" />
      <button onclick="addCustomSeries()">➕ Add Series</button>
      <div id="custom-series-list"></div>
    </section>
  </div>

  <script>
    let fullData = [];
    let keys = [];
    let visibleSeries = {};
    let currentMode = "lines";
    let currentYears = null;
    let customSeries = [];
    let traceDiff = null;

    const layout = {
      title: "FCI-G Components",
      xaxis: { title: "Date", rangeslider: { visible: true } },
      yaxis: { title: "Value" },
      legend: { orientation: "h" },
      margin: { t: 50, r: 20, l: 50, b: 100 }
    };

    function filterByYears(years) {
      if (!years) return fullData;
      const cutoff = new Date();
      cutoff.setFullYear(cutoff.getFullYear() - years);
      return fullData.filter(d => new Date(d.date) >= cutoff);
    }

    async function loadData() {
      const res = await fetch("./data/converted.json");
      fullData = await res.json();
      keys = Object.keys(fullData[0]).filter(k => k !== "date");

      keys.forEach(k => visibleSeries[k] = true);

      if (keys.includes("FFR") && keys.includes("10Yr Treasury")) {
        traceDiff = { name: "FFR - 10Yr Treasury" };
      }

      // lista serii pod wykresem
      const list = document.getElementById("series-list");
      keys.forEach(k => {
        const lbl = document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" checked onchange="toggleSeries('${k}')"> ${k}`;
        list.appendChild(lbl);
      });

      // dropdowny do custom series
      const col1 = document.getElementById("col1");
      const col2 = document.getElementById("col2");
      keys.forEach(k => {
        col1.innerHTML += `<option value="${k}">${k}</option>`;
        col2.innerHTML += `<option value="${k}">${k}</option>`;
      });

      updateChart();
    }

    function updateChart() {
      const filtered = filterByYears(currentYears);
      let traces = [];

      keys.forEach(k => {
        if (visibleSeries[k]) {
          const trace = {
            x: filtered.map(d => d.date),
            y: filtered.map(d => d[k]),
            name: k
          };
          if (currentMode === "stacked") {
            trace.stackgroup = "one";
          } else {
            trace.mode = "lines";
            trace.line = { width: 2 };
          }
          traces.push(trace);
        }
      });

      if (currentMode === "diff" && traceDiff) {
        traces.push({
          x: filtered.map(d => d.date),
          y: filtered.map(d => d["FFR"] - d["10Yr Treasury"]),
          mode: "lines",
          name: "FFR - 10Yr Treasury",
          line: { color: "purple", dash: "dot" }
        });
      }

      customSeries.forEach(s => {
        if (!s.hidden) {
          traces.push({
            x: filtered.map(d => d.date),
            y: s.fn(filtered),
            mode: "lines",
            name: s.name,
            line: { dash: "dot" }
          });
        }
      });

      Plotly.react("chart", traces, layout);
    }

    function toggleSeries(k) {
      visibleSeries[k] = !visibleSeries[k];
      updateChart();
    }

    function addCustomSeries() {
      const col1 = document.getElementById("col1").value;
      const op = document.getElementById("operation").value;
      const col2 = document.getElementById("col2").value;
      const name = document.getElementById("seriesName").value || `${col1} ${op} ${col2}`;

      const fn = (data) => data.map(d => {
        const a = d[col1] || 0;
        const b = d[col2] || 0;
        switch(op) {
          case "+": return a + b;
          case "-": return a - b;
          case "*": return a * b;
          case "/": return b !== 0 ? a / b : null;
        }
      });

      customSeries.push({ name, fn });

      const div = document.getElementById("custom-series-list");
      const lbl = document.createElement("label");
      lbl.innerHTML = `<input type="checkbox" checked onchange="toggleCustom('${name}')"> ${name}`;
      div.appendChild(lbl);

      updateChart();
    }

    function toggleCustom(name) {
      const s = customSeries.find(s => s.name === name);
      if (s) {
        s.hidden = !s.hidden;
        updateChart();
      }
    }

    // Drawer controls
    function openDrawer() {
      document.getElementById("drawer").classList.add("open");
      document.getElementById("drawer-overlay").classList.add("active");
    }
    function closeDrawer() {
      document.getElementById("drawer").classList.remove("open");
      document.getElementById("drawer-overlay").classList.remove("active");
    }

    // mode buttons
    ["lines","stacked","diff"].forEach(m => {
      document.getElementById("mode-"+m).onclick = () => {
        currentMode = m;
        highlight("mode-"+m, ["mode-lines","mode-stacked","mode-diff"]);
        updateChart();
      };
    });

    // range buttons
    [["all",null],["10y",10],["5y",5],["3y",3]].forEach(([id,years]) => {
      document.getElementById("range-"+id).onclick = () => {
        currentYears = years;
        highlight("range-"+id, ["range-all","range-10y","range-5y","range-3y"]);
        updateChart();
      };
    });

    function highlight(active, all) {
      all.forEach(id => document.getElementById(id).classList.remove("active"));
      document.getElementById(active).classList.add("active");
    }

    loadData();
  </script>
</body>
</html>
